name: KISWARM CI â€” Test & Quality

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # â”€â”€ Job 1: Unit & Integration Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ðŸ§ª Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ðŸ§ª Run test suite with coverage
        run: |
          pytest tests/ \
            --cov=python \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=60 \
            -v \
            --tb=short

      - name: ðŸ“Š Upload coverage report
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          files: ./coverage.xml
          flags: unittests
          name: kiswarm-coverage
          fail_ci_if_error: false

  # â”€â”€ Job 2: Code Quality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ðŸ“¦ Install quality tools
        run: |
          pip install flake8 black isort bandit

      - name: ðŸŽ¨ Check formatting (black)
        run: |
          black --check --diff python/ tests/ || echo "âš  Formatting issues found (non-blocking)"
        continue-on-error: true

      - name: ðŸ“ Check imports (isort)
        run: |
          isort --check-only --diff python/ tests/ || echo "âš  Import order issues (non-blocking)"
        continue-on-error: true

      - name: ðŸ”Ž Lint (flake8)
        run: |
          flake8 python/ tests/ \
            --max-line-length=100 \
            --extend-ignore=E203,W503 \
            --statistics || echo "âš  Lint issues found"
        continue-on-error: true

      - name: ðŸ”’ Security scan (bandit)
        run: |
          bandit -r python/ -ll -q || echo "âš  Security warnings found"
        continue-on-error: true

  # â”€â”€ Job 3: Shell Script Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  shellcheck:
    name: ðŸš Shell Script Validation
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: ðŸš Check deploy script
        run: |
          shellcheck deploy/kiswarm_deploy.sh \
            --severity=warning \
            --exclude=SC1091 || echo "âš  ShellCheck warnings found"
        continue-on-error: true

      - name: ðŸš Check all scripts
        run: |
          find scripts/ -name "*.sh" -exec shellcheck {} \
            --severity=warning \
            --exclude=SC1091 \; || echo "âš  ShellCheck warnings"
        continue-on-error: true

  # â”€â”€ Job 4: Deployment Script Syntax â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bash-syntax:
    name: âœ… Bash Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Validate bash syntax
        run: |
          for script in deploy/kiswarm_deploy.sh scripts/*.sh; do
            echo "Checking: $script"
            bash -n "$script" && echo "  âœ“ OK" || echo "  âœ— SYNTAX ERROR"
          done

  # â”€â”€ Job 5: Docker smoke test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docker-smoke:
    name: ðŸ³ Docker Smoke Test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Build test image
        run: |
          cat > /tmp/Dockerfile.test << 'EOF'
          FROM python:3.11-slim
          WORKDIR /kiswarm
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt 2>&1 | tail -5
          COPY python/ python/
          RUN python3 -c "from python.tool_proxy import app; print('âœ“ tool_proxy imports OK')" || \
              python3 -c "import sys; sys.path.insert(0,'python'); from tool_proxy import app; print('âœ“ OK')"
          EOF
          docker build -f /tmp/Dockerfile.test . -t kiswarm-test 2>&1 | tail -10
        continue-on-error: true

  # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-summary:
    name: ðŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [test, quality, shellcheck, bash-syntax]
    if: always()

    steps:
      - name: ðŸ“‹ Print summary
        run: |
          echo "========================================"
          echo "  KISWARM v1.1 â€” CI/CD Pipeline Summary"
          echo "========================================"
          echo "  Tests:       ${{ needs.test.result }}"
          echo "  Quality:     ${{ needs.quality.result }}"
          echo "  ShellCheck:  ${{ needs.shellcheck.result }}"
          echo "  Bash Syntax: ${{ needs.bash-syntax.result }}"
          echo "========================================"
          echo "  Repo: https://github.com/Baronki2/KISWARM"
