name: KISWARM CI â€” Test & Quality

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:   # â† Allows manual trigger from GitHub UI

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # â”€â”€ Job 1: Unit & Integration Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ğŸ§ª Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ğŸ§ª Run test suite with coverage
        run: |
          pytest tests/ \
            --cov=python \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-fail-under=50 \
            -v \
            --tb=short \
            -p no:warnings
        env:
          KISWARM_HOME: ${{ runner.temp }}/kiswarm_test

      - name: ğŸ“Š Upload coverage report
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11' && always()
        with:
          files: ./coverage.xml
          flags: unittests
          name: kiswarm-coverage
          fail_ci_if_error: false
        continue-on-error: true

  # â”€â”€ Job 2: Code Quality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ğŸ“¦ Install quality tools
        run: pip install flake8 black isort bandit

      - name: ğŸ¨ Check formatting (black)
        run: black --check --diff python/ tests/ 2>&1 || echo "âš  Formatting suggestions found"
        continue-on-error: true

      - name: ğŸ“ Check imports (isort)
        run: isort --check-only --diff python/ tests/ 2>&1 || echo "âš  Import order suggestions"
        continue-on-error: true

      - name: ğŸ” Lint (flake8)
        run: |
          flake8 python/ tests/ \
            --max-line-length=100 \
            --extend-ignore=E203,W503,E501 \
            --statistics 2>&1 || echo "âš  Lint suggestions found"
        continue-on-error: true

      - name: ğŸ”’ Security scan (bandit)
        run: bandit -r python/ -ll -q 2>&1 || echo "âš  Security review suggestions"
        continue-on-error: true

  # â”€â”€ Job 3: Shell Script Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  shellcheck:
    name: ğŸš Shell Script Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: ğŸš Check deploy script
        run: |
          shellcheck deploy/kiswarm_deploy.sh \
            --severity=warning \
            --exclude=SC1091,SC2129 2>&1 || echo "âš  ShellCheck suggestions"
        continue-on-error: true

      - name: ğŸš Check all scripts
        run: |
          find scripts/ -name "*.sh" | while read script; do
            echo "Checking: $script"
            shellcheck "$script" --severity=warning --exclude=SC1091,SC2129 \
              2>&1 || echo "  âš  Issues in $script"
          done
        continue-on-error: true

  # â”€â”€ Job 4: Bash Syntax Check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  bash-syntax:
    name: âœ… Bash Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âœ… Validate bash syntax (all scripts)
        run: |
          echo "Validating bash syntax..."
          ALL_PASS=true
          for script in deploy/kiswarm_deploy.sh scripts/*.sh; do
            if bash -n "$script" 2>&1; then
              echo "  âœ“ $script"
            else
              echo "  âœ— SYNTAX ERROR: $script"
              ALL_PASS=false
            fi
          done
          $ALL_PASS && echo "All scripts have valid syntax!" || exit 1

  # â”€â”€ Job 5: Python Import Smoke Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  smoke-test:
    name: ğŸ’¨ Python Import Smoke Test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: ğŸ“¦ Install production deps
        run: pip install -r requirements.txt

      - name: ğŸ’¨ Test tool_proxy imports
        run: |
          cd python
          python -c "
          import sys, os
          os.environ['KISWARM_HOME'] = '/tmp/kiswarm_smoke'
          os.makedirs('/tmp/kiswarm_smoke/KISWARM/central_tools_pool', exist_ok=True)
          os.makedirs('/tmp/kiswarm_smoke/logs', exist_ok=True)
          from tool_proxy import app, load_config, safe_name, get_tools
          print('âœ“ tool_proxy imports OK')
          cfg = load_config()
          print(f'âœ“ load_config returns dict: {list(cfg.keys())}')
          assert safe_name('valid_tool') == True
          assert safe_name('../evil') == False
          print('âœ“ safe_name() working correctly')
          "

      - name: ğŸ’¨ Test kiswarm_status imports
        run: |
          cd python
          python -c "
          import os
          os.environ['KISWARM_HOME'] = '/tmp/kiswarm_smoke'
          from kiswarm_status import KISWARMMonitor
          m = KISWARMMonitor()
          print('âœ“ KISWARMMonitor imports OK')
          import datetime
          assert isinstance(m.start_time, datetime.datetime)
          print('âœ“ Monitor initializes correctly')
          "

  # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-summary:
    name: ğŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [test, quality, shellcheck, bash-syntax, smoke-test]
    if: always()

    steps:
      - name: ğŸ“‹ Print CI summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     KISWARM v1.1 â€” CI/CD Pipeline Summary           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸ§ª Tests:        ${{ needs.test.result }}"
          echo "â•‘  ğŸ” Quality:      ${{ needs.quality.result }}"
          echo "â•‘  ğŸš ShellCheck:   ${{ needs.shellcheck.result }}"
          echo "â•‘  âœ… Bash Syntax:  ${{ needs.bash-syntax.result }}"
          echo "â•‘  ğŸ’¨ Smoke Tests:  ${{ needs.smoke-test.result }}"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸŒ https://github.com/Baronki2/KISWARM             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
